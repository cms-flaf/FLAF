name: Check repository state

on:
  pull_request:
    types: [ "opened", "synchronize", "reopened", "labeled" ]
  workflow_call:

permissions:
  contents: read

jobs:
  calculate-size:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          fetch-depth: 0

      - name: Set global git properties:
        run: |
          git config --global user.email "cms-flaf@proton.me"
          git config --global user.name "CMS FLAF Integration Bot"

      - name: Git GC before
        run: git gc --aggressive --prune=now

      - name: Measure size before
        id: size_before
        run: echo "size=$(du -sb .git | cut -f1)" >> $GITHUB_OUTPUT

      - name: Fetch PR branch
        run: git fetch origin pull/${{ github.event.pull_request.number }}/head:PR_${{ github.event.pull_request.number }}

      - name: Simulate squash merge
        run: |
          git checkout ${{ github.base_ref }}
          git merge --squash PR_${{ github.event.pull_request.number }}
          git commit -m "Simulated squash merge of PR #${{ github.event.pull_request.number }}"

      - name: Remove PR branch ref
        run: |
          git branch -D PR_${{ github.event.pull_request.number }}
          git update-ref -d refs/remotes/origin/pull/${{ github.event.pull_request.number }}

      - name: Git GC after
        run: git gc --aggressive --prune=now

      - name: Measure size after
        id: size_after
        run: echo "size=$(du -sb .git | cut -f1)" >> $GITHUB_OUTPUT

      - name: Calculate and report delta
        run: |
          delta=$(( ${{ steps.size_after.outputs.size }} - ${{ steps.size_before.outputs.size }} ))
          delta_kb=$(( delta / 1024 ))
          echo "Repository size would increase by approximately $delta_kb KiB if this PR is squash merged."
          echo "::notice title=PR Size Increase::Repository size would increase by approximately $delta_kb KiB if this PR is squash merged."
